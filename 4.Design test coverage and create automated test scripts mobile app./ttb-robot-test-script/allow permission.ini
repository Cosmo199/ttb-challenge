***Settings***
Library           AppiumLibrary    # Import AppiumLibrary เพื่อให้ Robot Framework รู้จักคำสั่ง Appium
Test Setup        Open Application And Handle Permissions    # กำหนด Keyword ที่จะรันก่อนทุก Test Case
Test Teardown     Close Application           # กำหนด Keyword ที่จะรันหลังทุก Test Case

***Variables***
# --- Appium Server & Platform Settings ---
${APPIUM_SERVER_URL}      http://127.0.0.1:4723/wd/hub  # URL ของ Appium Server
${PLATFORM_NAME}          Android                       # แพลตฟอร์มที่ต้องการทดสอบ
${DEVICE_NAME}            Test App                      # ชื่ออุปกรณ์ (เช่น ชื่อ Emulator ที่คุณสร้าง หรือชื่อมือถือจริง)
${AUTOMATION_NAME}        UiAutomator2                  # Automation engine ที่แนะนำสำหรับ Android

# --- Application (APK) Specific Settings ---
# *** สำคัญ: ต้องเปลี่ยน Path ของไฟล์ APK, Package Name และ Activity หลักให้ถูกต้อง ***
${APP_PATH}               /Users/nawakarn/Desktop/apk/3bbmember(billPDF).apk  # Path เต็มของไฟล์ APK ของคุณ
${APP_PACKAGE}            com.inc.tbb_vip               # << ใส่ Package Name ที่ถูกต้องของคุณที่นี่
${APP_ACTIVITY}           com.inc.tbb_vip.MainActivity  # << ใส่ Activity หลักที่ถูกต้องของคุณที่นี่

# --- Optional Appium Capabilities ---
# ${NO_RESET}             TRUE                          # บรรทัดนี้ถูกคอมเมนต์/ลบออกไปแล้ว
${NEW_COMMAND_TIMEOUT}    600                           # เวลาที่ Appium จะรอคำสั่งใหม่ก่อนปิดเซสชั่น (วินาที)

# --- Test Specific Variables ---
${WAIT_TIME_SECONDS}      100                           # สำหรับ Test Case "Observe" (2 นาที)
${ELEMENT_TIMEOUT}        30s                           # Timeout สำหรับการรอ Element เป็น 30 วินาที

# XPath ของช่องกรอกข้อมูล Username
${USERNAME_INPUT_XPATH}   //android.widget.EditText[@text="อีเมลหรือชื่อผู้ใช้"]
# XPath ของช่องกรอกข้อมูล Password
${PASSWORD_INPUT_XPATH}   //android.widget.EditText[@text="รหัสผ่าน"]
# XPath ของปุ่มเข้าสู่ระบบ
${LOGIN_BUTTON_XPATH}     //android.widget.FrameLayout[@resource-id="android:id/content"]/android.widget.FrameLayout/android.view.ViewGroup/android.view.ViewGroup/android.view.ViewGroup/android.view.ViewGroup/android.view.ViewGroup/android.view.ViewGroup[3]/android.view.ViewGroup/android.view.View

# --- Permission Buttons (อาจต้องปรับตาม Android OS Version และภาษา) ---
# ปุ่ม "อนุญาต" ทั่วไป (Resource ID)
${ALLOW_PERMISSION_BUTTON_ID}               com.android.permissioncontroller:id/permission_allow_button
# ปุ่ม "อนุญาตขณะใช้แอป" สำหรับ Location (Resource ID)
${ALLOW_FOREGROUND_PERMISSION_BUTTON_ID}    com.android.permissioncontroller:id/permission_allow_foreground_only_button
# ปุ่ม "อนุญาตตลอดเวลา" (Resource ID, อาจปรากฏหลังจาก "อนุญาตขณะใช้แอป")
${ALLOW_ALWAYS_PERMISSION_BUTTON_ID}        com.android.permissioncontroller:id/permission_allow_always_button

# ปุ่ม "Allow only while using the app" (English Text XPath)
${ALLOW_FOREGROUND_PERMISSION_BUTTON_ENGLISH_XPATH}    //android.widget.Button[@text="While using the app"]
# ปุ่ม "Allow" ทั่วไป (English Text XPath)
${ALLOW_PERMISSION_BUTTON_ENGLISH_XPATH}    //android.widget.Button[@text="While using the app"]
# ปุ่ม "อนุญาต" ถ้าเป็นข้อความภาษาไทย (สำรอง, Thai Text XPath)
${ALLOW_PERMISSION_BUTTON_THAI_XPATH}       //android.widget.Button[@text="While using the app"]


***Keywords***
Open Application And Handle Permissions
    [Documentation]    Keyword to open the Android application and handle common runtime permissions.
    Log To Console     Starting to open 3BB Member Android application...
    Open Application    ${APPIUM_SERVER_URL}
    ...    platformName=${PLATFORM_NAME}
    ...    deviceName=${DEVICE_NAME}
    ...    automationName=${AUTOMATION_NAME}
    ...    app=${APP_PATH}
    ...    appPackage=${APP_PACKAGE}
    ...    appActivity=${APP_ACTIVITY}
    ...    newCommandTimeout=${NEW_COMMAND_TIMEOUT}
    Log To Console     3BB Member Application opened successfully.

    # เรียกใช้ Keyword จัดการ Permissions
    Handle Android Permissions

Handle Android Permissions
    [Documentation]    Attempts to click common 'Allow' buttons for runtime permissions.
    Log To Console     Attempting to handle Android permissions...
    Sleep    1s

    # Try clicking the "While using the app" button (by ID, common for Location)
    Run Keyword And Ignore Error    Wait Until Page Contains Element    id=${ALLOW_FOREGROUND_PERMISSION_BUTTON_ID}    timeout=5s
    Run Keyword And Ignore Error    Click Element                       id=${ALLOW_FOREGROUND_PERMISSION_BUTTON_ID}
    Run Keyword And Ignore Error    Log To Console                      Clicked 'While using the app' button (by ID, if present).
    Sleep    1s

    # Try clicking the generic "While using the app" button (by ID, common for Storage/Photos)
    Run Keyword And Ignore Error    Wait Until Page Contains Element    id=${ALLOW_PERMISSION_BUTTON_ID}    timeout=5s
    Run Keyword And Ignore Error    Click Element                       id=${ALLOW_PERMISSION_BUTTON_ID}
    Run Keyword And Ignore Error    Log To Console                      Clicked generic 'While using the app' button (by ID, if present).
    Sleep    1s

    # Try clicking the "While using the app" button (by ID)
    Run Keyword And Ignore Error    Wait Until Page Contains Element    id=${ALLOW_ALWAYS_PERMISSION_BUTTON_ID}    timeout=5s
    Run Keyword And Ignore Error    Click Element                       id=${ALLOW_ALWAYS_PERMISSION_BUTTON_ID}
    Run Keyword And Ignore Error    Log To Console                      Clicked 'While using the app all the time' button (by ID, if present).
    Sleep    1s

    # Try clicking "While using the app" by English text (alternative)
    Run Keyword And Ignore Error    Wait Until Page Contains Element    xpath=${ALLOW_FOREGROUND_PERMISSION_BUTTON_ENGLISH_XPATH}    timeout=5s
    Run Keyword And Ignore Error    Click Element                       xpath=${ALLOW_FOREGROUND_PERMISSION_BUTTON_ENGLISH_XPATH}
    Run Keyword And Ignore Error    Log To Console                      Clicked 'While using the app' button (by English text, if present).
    Sleep    1s

    # Try clicking generic "While using the app" button by English text (alternative)
    Run Keyword And Ignore Error    Wait Until Page Contains Element    xpath=${ALLOW_PERMISSION_BUTTON_ENGLISH_XPATH}    timeout=5s
    Run Keyword And Ignore Error    Click Element                       xpath=${ALLOW_PERMISSION_BUTTON_ENGLISH_XPATH}
    Run Keyword And Ignore Error    Log To Console                      Clicked generic 'While using the app' button (by English text, if present).
    Sleep    1s


    Log To Console     Finished attempting to handle permissions.

***Test Cases***

Open 3BB Member App And Observe For 2 Minutes
    [Documentation]    This test case launches the 3BB Member Android app, waits for 5 minutes, then closes it.
    Log To Console     Waiting for ${WAIT_TIME_SECONDS} seconds to observe the application...
    Sleep              2s
    Log To Console     Finished observation. Application will be closed by Test Teardown.


Input Username, Password And Click Login Button
    [Documentation]    This test case inputs username and password, then clicks the login button.
    # ให้แอปโหลดหน้าจอแรกให้เต็มที่ก่อนจะเริ่มหา Element แรก
    Sleep                               5s

    # กรอก Username
    Wait Until Page Contains Element    ${USERNAME_INPUT_XPATH}    timeout=${ELEMENT_TIMEOUT}
    Input Text                          ${USERNAME_INPUT_XPATH}    457039082
    Log To Console                      Entered '457039082' into the username field.
    Sleep                               2s

    # กรอก Password
    Wait Until Page Contains Element    ${PASSWORD_INPUT_XPATH}    timeout=${ELEMENT_TIMEOUT}
    Input Text                          ${PASSWORD_INPUT_XPATH}    457039082
    Log To Console                      Entered '457039082' into the password field.
    Sleep                               2s

    # กดปุ่มเข้าสู่ระบบ
    Wait Until Page Contains Element    ${LOGIN_BUTTON_XPATH}      timeout=${ELEMENT_TIMEOUT}
    Click Element                       ${LOGIN_BUTTON_XPATH}
    Log To Console                      Clicked the login button.
    Sleep                               5s
    # Application will be closed by Test Teardown.